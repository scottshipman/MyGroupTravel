{% extends '::site-base.html.twig' %}
{% if 'en_GB' in locale %} {% set format = 'd M Y' %} {% else %} {% set format = 'M d Y' %} {% endif %}
{% set spotsRemaining = tour.payingPlaces - acceptedcount %}

{% block title %}
    {% if is_granted("ROLE_BRAND") %}
        {{ tour.name }} {% trans %}passenger.title.show{% endtrans %}
    {% else %}
        {{ tour.name }}
    {% endif %}
{% endblock %}

{% block page_title %}
    <span>{% trans %}passenger.page_title.index{% endtrans %}</span>
{% endblock %}

{% block page_title_menu %}
    <button id="tour-title-drop" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon title-menu-drop">
        <i class="material-icons">arrow_drop_down</i>
    </button>
    {% embed "TourBundle:Tour:tourMenu.html.twig" %}
            {% block tour_dashboard_link %}
                <li><a href="{{ path('manage_tour_show', { 'id': tour.id }) }}" class="mdl-menu__item">{% trans %}tour.title.index{% endtrans %}</a></li>
            {% endblock %}
    {% endembed %}
{% endblock %}

{% block back_link %}

        <a class="back-link" href="{{ path('manage_tour_show', { 'id': tour.id }) }}"><i class="fa fa-arrow-left"></i> {% trans %}passenger.actions.back{% endtrans %}</a>

{% endblock %}

{% block body -%}

    <div class="tour-show-wrapper site-show" entityId="{{ tour.id }}">

        <div class="tour-show-left-column">
            <ul class="tour-show-submenu">
                <li><strong>{% trans %}passenger.labels.passengers_for{% endtrans %} {{ tour.name|capitalize }}</strong></li>
                <li><a class="passenger-filter" style="color: {{ brand.primaryColor }}; text-decoration: none;" href="" id="showAccepted"><strong>{% trans %}passenger.labels.accepted{% endtrans %} ({{ acceptedcount }})</strong></a></li>
                <li><a class="passenger-filter" style="color: {{ brand.primaryColor }}; text-decoration: none;" href="" id="showWaitlist"><strong>{% trans %}passenger.labels.waitlist{% endtrans %} ({{ waitlistcount }})</strong></a></li>
                <li><a class="passenger-filter" style="color: {{ brand.primaryColor }}; text-decoration: none;" href="" id="showFree"><strong>{% trans %}passenger.labels.free{% endtrans %} ({{ freecount }})</strong></a></li>
                <li><a class="passenger-filter" style="color: {{ brand.primaryColor }}; text-decoration: none;" href="" id="showOrganizers"><strong>{% trans %}passenger.labels.organizer{% endtrans %} ({{ organizerscount }})</strong></a></li>
            </ul>

            <div class="tour-edit-organizer-left">
                <label>{% trans %}tour.show.organizers{% endtrans %}</label><br>
                {% if tour.organizer.media %}
                    <img class="tui-image-avatar" src="{{ ( tour.organizer.media.getRelativePath ~ "/" ~ tour.organizer.media.getHashedFilename ) | imagine_filter('thumbnail') }}" alt="{{ tour.organizer.username }}">
                {% elseif tour.organizer.firstName and tour.organizer.lastName %}
                    <span class="tui-text-avatar mdl-typography--headline">{{ tour.organizer.firstName[:1] }}{{ tour.organizer.lastName[:1] }}</span>
                {% else %}
                    <span class="tui-text-avatar mdl-typography--headline">{{ tour.organizer.username[:1] }}</span>
                {% endif %}
                {#<a class="add-organizer" href="#"><i class="add-icon fa fa-plus"></i></a>#}
                {#<a class="add-organizer mdl-button mdl-js-button mdl-button--raised mdl-button--colored" href="#">Add/remove organizers</a>#}
            </div>
        </div>

        <div class="tour-show-right-column">

            <div class="tour-edit mdl-card mdl-shadow--2dp" style="margin-bottom: 0; box-shadow: none;">

                <div class="mdl-card__title">
                    <h3 class="mdl-card__title-text">{% trans %}passenger.labels.passenger_list{% endtrans %}</h3>
                </div>

                <div class="mdl-card__supporting-text mdl-card--border" style="color:grey;">
                    <div class="paying-passengers-title"><h3>{% trans %}passenger.labels.add_paying{% endtrans %}</h3></div> <div class="passenger-count"><p style="color: {{ brand.primaryColor }}" class="spots-remaining">{{ spotsRemaining }}</p><p class="spots-remaining-copy"><strong>{% trans %}passenger.labels.remaining{% endtrans %}</strong></p></div>
                    <p class="passenger-dashboard-copy">{% trans %}passenger.labels.welcome{% endtrans %}</p>
                    <div style="clear: both"></div>
                    <a id="invite-passengers" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored passenger-dashboard-buttons" href="#"><i class="fa fa-users"></i>{% trans %}passenger.labels.invite{% endtrans %}</a>
                    <a id="accept-tour" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored passenger-dashboard-buttons" href="#"><i class="fa fa-user-plus"></i>{% trans %}passenger.labels.add{% endtrans %}</a>
                </div>
            </div>
                {% for passenger in passengers %}
                {% if passenger[0].p_free == 1 %}{% set freeClass = 'free' %} {% else %} {% set freeClass = 'paid' %} {% endif %}
                    <div class="{{ passenger[0].p_status }} {{ freeClass }}tour-edit mdl-shadow--2dp" style="background-color:white; margin-bottom: 0;">
                        <div class="mdl-card__supporting-text mdl-card--border" style="color:grey;">
                            <div style="float: left; color: grey;">
                                <p style="display: inline-block"><strong>{{ passenger[0].p_fName }}</strong></p> <p style="display: inline-block"><strong>{{ passenger[0].p_lName }}</strong></p> <p style="display: inline-block"><strong><a href="mailto:{{ passenger[1].email }}">{{ passenger[1].email }}</a></strong></p>
                                <label style="display: block">Signed up on {{ passenger[0].p_signUpDate|date(format) }}</label>
                            </div>
                            <button style="position: absolute; right: 20px; color:grey; margin-top:10px;" id="passenger-actions-menu-drop-{{ passenger[0].p_id }}" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
                                <i class="material-icons">more_vert</i>
                            </button>
                            {% embed "PassengerBundle:Passenger:passengerActionsMenu.html.twig" %}{% endembed %}
                           {#{% embed "PassengerBundle:Passenger:passengerActionsMenu.html.twig" %}{% endembed %}#}
                        </div>

                    </div>
                {% endfor %}
            </div>
        </div>

    </div>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/zeroclipboard/2.2.0/ZeroClipboard.js"></script>

    {% javascripts '@toolkit_siteshow' %}
        <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}

    {% javascripts '@toolkit_passenger' %}
        <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}

    <script>
        $(document).ready(function () {

                // Promote Popup
                $(document).on('click', '#invite-passengers', function (e) {
                    e.preventDefault();
                    var shareValue = "{{ url('tour_site_show', { 'id': tour.id, 'quoteNumber' : tour.quoteNumber }) }}";
                    var link_html = '<h3>Share this Tour with others</h3>' +
                                      '<div><p>To send this tour to others, copy the URL below.</p></div>' +
                                      '<div class="input"><input style="width:70%; padding:.25em; margin:1em;" type="text" id="share_url" name="share_url" value="' + shareValue + '" readonly="readonly">' +
                                      '<a href="#" id="copy-button" data-clipboard-target="share_url"' +
                                      'title="Click to copy Tour URL"' +
                                      'class="not-full mdl-button mdl-js-button mdl-button--raised mdl-button--colored">' +
                                      '<i class="fa fa-sign-in fa-stack"></i>' +
                                      '</a></div>';
                    toolkitStaticPopup("Promote the Tour", link_html);
                    // Copy to Clipboard
                    ZeroClipboard.config({swfPath: "//cdnjs.cloudflare.com/ajax/libs/zeroclipboard/2.2.0/ZeroClipboard.swf"});
                    var client = new ZeroClipboard(document.getElementById("copy-button"));
                    client.on('aftercopy', function (event) {
                        $('#copy-button').css('background-color', 'green');
                    });
                    //remove the CopytoClipboard button if not Flash
                    if (navigator.mimeTypes["application/x-shockwave-flash"] == undefined) {
                        $("#copy-button").addClass('hidden');
                        $('share_url').css('width', '80%');
                    };

                });

                $(document).on('click', '.passenger-filter', function (e){
                    e.preventDefault();
                    var elemID = this.id;
                    switch(elemID) {
                        case 'showAccepted':
                            $('.free, .organizers, .waitlist').slideUp(400);
                            $('.accepted').slideDown(400);
                            break;
                        case 'showWaitlist':
                            $('.accepted, .organizers, .free').slideUp(400);
                            $('.waitlist').slideDown(400);
                            break;
                        case 'showFree':
                            $('.accepted, .waitlist, .organizers').slideUp(400);
                            $('.free').slideDown(400);
                            break;
                        case 'showOrganizers':
                            $('.accepted, .waitlist, .free').slideUp(400);
                            $('.organizers').slideDown(400);
                            break;
                        default:
                            // do nothing
                            break;
                    }
                });

        });
    </script>
{% endblock %}

{% block footer_left %}
    {% if app.user.email != tour.salesAgent.email%} {# Show Sales Agent Info to an Organizer#}
        {% if tour.salesAgent %}
            <span class="intro">
                    {{ brand.name }} {% trans %}tour.show.footer.intro_org{% endtrans %}
            </span>
            {% if tour.salesAgent.media %}
                <span class="tui-image-avatar"><img src="{{ ( tour.salesAgent.media.getRelativePath ~ "/" ~ tour.salesAgent.media.getHashedFilename ) | imagine_filter('thumbnail') }}" alt="{{ tour.salesAgent.username }}"></span>
            {% elseif tour.salesAgent.firstName and tour.salesAgent.lastName %}
                <span class="tui-text-avatar mdl-typography--headline">{{ tour.salesAgent.firstName[:1] }}{{ tour.salesAgent.lastName[:1] }}</span>
            {% else %}
                <span class="tui-text-avatar mdl-typography--headline">{{ tour.salesAgent.username[:1] }}</span>
            {% endif %}
            <span class="agent">
                {% if tour.salesAgent.displayName %}
                    {{ tour.salesAgent.displayName }}
                {% else %}
                    {{ tour.salesAgent.firstName }} {{ tour.salesAgent.lastName }}
                {% endif %}
                <br>
                <a href="mailto:{{ tour.salesAgent.email }}">{{ tour.salesAgent.email }}</a>
            </span>
        {% endif %}
    {% else %} {# Show organizer info to everyone but organizers #}
        {% if tour.organizer %}
            <span class="intro">
                    {% trans %}tour.show.footer.intro{% endtrans %}
            </span>
            {% if tour.organizer.media %}
                <span class="tui-image-avatar"><img src="{{ ( tour.organizer.media.getRelativePath ~ "/" ~ tour.organizer.media.getHashedFilename ) | imagine_filter('thumbnail') }}" alt="{{ tour.organizer.username }}"></span>
            {% elseif tour.organizer.firstName and tour.organizer.lastName %}
                <span class="tui-text-avatar mdl-typography--headline">{{ tour.organizer.firstName[:1] }}{{ tour.organizer.lastName[:1] }}</span>
            {% else %}
                <span class="tui-text-avatar mdl-typography--headline">{{ tour.organizer.username[:1] }}</span>
            {% endif %}
            <span class="agent">
                {% if tour.organizer.displayName %}
                    {{ tour.organizer.displayName }}
                {% else %}
                    {{ tour.organizer.firstName }} {{ tour.organizer.lastName }}
                {% endif %}
                <br>
                <a href="mailto:{{ tour.organizer.email }}">{{ tour.organizer.email }}</a>
            </span>
        {% endif %}
    {% endif %}
{% endblock %}

{% block footer_right %}
    <div class="quote-info">
        <span class="quote-label">{% trans %}tour.show.footer.price{% endtrans %}</span>

        <span class="quote-price">
            {% if tour.pricePerson %}
                <strong>{% if tour.currency %}{{ tour.currency.htmlSymbol | raw }}{% endif %}{{ tour.pricePersonPublic }}</strong>
            {% endif %}
        </span>
    </div>
{% endblock %}