

{% block body -%}

    <p>{{ 'payment.form.message' | trans ({'%fname%': passenger.fname, '%lname%': passenger.lname, '%tourname%': tour.name }) }}</p>

    <div class="errors">
        {{ form_errors(form) }}
    </div>

    {{ form_start(form) }}
    {{ form_row(form.value) }}
    {{ form_row(form.date) }}
    {{ form_row(form.note) }}

    {{ form_widget(form.tour) }}
    {{ form_widget(form.passenger) }}

    {{ form_rest(form) }}
    {{ form_end(form) }}

    <ul class="record_actions">
        <a href="" class="cancel">Cancel</a>
    </ul>
    {{ form_javascript(form) }}

    <script>
        $(document).ready(function () {
            $(document).on('click', 'a.cancel', function(e) {
                e.preventDefault();
                $("#dialog").html("");
                $("#dialog").dialog("close");
            });

//            //Bind the ajax form
            $('#ajax_new_payment_form').on('submit', function(e) {
                $("#loader").css("display", "block");
                e.preventDefault();
                $('.errors').html('');
                var formAction = $(this).attr('action');
                var form =$(this);
                $.ajax({
                    url: formAction,
                    type: 'POST',
                    headers: {
                        "Pragma": "no-cache",
                        "Expires": -1,
                        "Cache-Control": "no-cache"
                    },
                    data: $('#ajax_new_payment_form').serialize(),
                    contentType: "application/x-www-form-urlencoded"
                }).success(function (response) {
                    $("#dialog").html("");
                    $("#dialog").dialog("close");
                    $(window).scrollTop(0);
                    // @todo Perhaps add notification message?
                    // update payment dashboard stuff
                    var id = response['passenger']['id'];
                    var markup = ''; // @todo - get markup from getPassengerPaymentMiniCardAction - no route as yet
                    $('[passenger="'+id+'"]').html(markup);
                    // now call the route to get the data for the person!

                    //window.location.reload(true);
                    $('#loader').css('display', 'none');
                }).error(function (response) {
                    $("#loader").hide();

                    var field= '#tui_toolkit_paymentbundle_payment_';
                    ajaxFormErrors(response, field);

                });
            });

        });

        function pingDashboard() {

            var url = '/tour/dashboard/{{ tour.id }}/show';

            return $.ajax({
                url: url,
                type: 'GET',
                headers: {
                    "Pragma": "no-cache",
                    "Expires": -1,
                    "Cache-Control": "no-cache"
                }
            });
        }

        function getPassengerPayment() {

            var url = '/tour/dashboard/{{ tour.id }}/completed/setup';

            return $.ajax({
                url: url,
                type: 'GET',
                headers: {
                    "Pragma": "no-cache",
                    "Expires": -1,
                    "Cache-Control": "no-cache"
                }
            });
        }

        function updateSidebar(content) {
            $('#tour-completed-right-column').html(content);
            $('#loader').hide();
            // @todo add an alert here?
        }

    </script>

{% endblock %}
