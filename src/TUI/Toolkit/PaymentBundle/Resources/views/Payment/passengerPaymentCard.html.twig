{% if 'en_GB' in locale %} {% set format = 'd M Y' %} {% else %} {% set format = 'M d Y' %} {% endif %}

<div class="waitlist tour-edit mdl-card mdl-shadow--2dp">
    <div class="mdl-card__title">
        <h3 class="mdl-card__title-text">{% trans %}passenger.labels.payments{% endtrans %}</h3>

          {# only if an organizer or brand #}
        {% if 0==0 %}
                <button id="payment-actions-menu-drop-{{ passenger.id }}" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon title-button">
                    <i class="material-icons">more_vert</i>
                </button>
            <a href="#"><i id="passenger-close" style="display: none;" class="material-icons" passenger="{{ passenger.id }}">close</i></a>
            {% embed "PaymentBundle:Payment:paymentSubMenu.html.twig" %}{% endembed %}

        {% endif %}
        <div class="clear"></div>
    </div>
    <div class="mdl-card__supporting-text mdl-card--border">
        {% if paymentTasks is not empty %}
            {% set overdue = 0 %}
            <ul class="passenger-payment-tasks" style="list-style-type: none">
                {% for paymentTask in paymentTasks %}
                    {% set overdue = overdue + paymentTask.overdueAmt %}
                        {%  set color = 'blue' %}{%  set icon = 'event' %}
                        {% if paymentTask.status == "paid" %}{%  set color = 'green' %}{%  set icon = 'done' %} {% endif %}
                        {% if paymentTask.status ==  "overdue" %}{%  set color = 'red' %}{%  set icon = 'warning' %}{% endif %}

                  <li>
                      <i style="color:{{ color }};" class="material-icons" >{{ icon }}</i>
                      <label>{{ paymentTask.item.name }}</label> due <span class="payment-date">{{ paymentTask.item.dueDate | date(format) }}</span> {{ currency.htmlSymbol | raw  }}{{ paymentTask.credit }} paid of {{ currency.htmlSymbol | raw  }}{{ paymentTask.item.value }}
                  </li>
                {% endfor %}
            </ul>

        {% endif %}
        <p><span>{{ currency.htmlSymbol | raw  }}{{ payments.total }}</span> total paid of <span>{{ currency.htmlSymbol | raw  }}{{ due.total }}</span> total due.
            {% if payments.total >0  %}
                <span id="payment-history-link"><a href="" id="toggle-payment-history" class="payment-history-link">view payment history</a></span>
                <div style="display:none;" id="payment-history">
                    <h4>Payment History</h4>
                        <ul>
                            {% for paid in payments.items %}
                            <li>
                                {{ currency.htmlSymbol | raw  }}{{ paid.value }} on {{ paid.date | date(format)}} {% if paid.note is not empty %}- {{ paid.note }} {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                </div>
            {% endif %}
        </p>
        {% if overdue > 0 %}
            <div style="color:red">There is a past due balance of {{ currency.htmlSymbol | raw  }}{{ overdue }}</div>
        {% endif %}
    </div>
</div>
<script>
    $(document).ready(function () {

            // Payment popup
            $(document).on('click', 'a.make-a-payment', function (e) {
            var t = $(this);
            e.preventDefault();
            var passengerId = t.attr('passenger');
            var tourId = t.attr('tour');
            //$("#loader").css("display", "block");
            toolkitStandardPopup("Log A Payment", '/payment/tour/' + tourId + '/passenger/' + passengerId + '/new' );
            });

            // Customize a passenger's payment schedule
            $(document).on('click', 'a.edit-payment-schedule', function (e) {
                var t = $(this);
                e.preventDefault();
                var passengerId = t.attr('passenger');
                var tourId = t.attr('tour');
                //$("#loader").css("display", "block");
                toolkitStandardPopup("Customize {{ passenger.fname }}'s Payment Schedule", '/payment/tour/' + tourId + '/passenger/' + passengerId + '/customize' );
            });


            // toggle payment history
            $(document).on('click', 'a.payment-history-link', function(e){
                e.preventDefault();
                $('#payment-history').toggle(400, function(){
                    if ($('#toggle-payment-history').html()=='view payment history') {
                        $('#toggle-payment-history').text('hide payment history');
                    } else {
                        $('#toggle-payment-history').text('view payment history');
                    }
                });
            });

    });
</script>